# ========================================
# .github/workflows/ci.yml
# ========================================
name: CI Pipeline

on:
  push:
    branches: [ main, develop, testmodel ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black

      - name: Lint with flake8
        run: |
          cd backend
          # Stop on syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,migrations

      - name: Format check with black
        run: |
          cd backend
          black --check --exclude='venv|migrations' .
        continue-on-error: true

      - name: Run Django checks
        run: |
          cd backend
          python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: config.settings
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: True

  frontend-lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('frontend/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: Lint code
        run: |
          cd frontend
          bun run lint || echo "Linting completed with warnings"
        continue-on-error: true

      - name: Build project
        run: |
          cd frontend
          bun run build
        env:
          VITE_API_URL: http://localhost:8000/api

  docker-build-test:
    runs-on: ubuntu-latest
    needs: [backend-lint-and-test, frontend-lint-and-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create external network for testing
        run: |
          docker network create app-network || true

      - name: Create test .env file
        run: |
          cat > backend/.env << 'EOF'
          DJANGO_SECRET_KEY=test-secret-key-for-ci-only
          DEBUG=True
          DB_ENGINE=django.db.backends.sqlite3
          DB_NAME=:memory:
          EOF

      - name: Build backend image
        run: |
          docker build -t yaw-backend:test ./backend

      - name: Build frontend image
        run: |
          docker build -t yaw-frontend:test ./frontend

      - name: Test docker-compose config
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml config

      - name: Verify Docker Compose version
        run: |
          docker compose version

      - name: Validate compose file syntax
        run: |
          docker compose -f docker-compose.yml config --quiet

      - name: Cleanup
        if: always()
        run: |
          docker network rm app-network || true