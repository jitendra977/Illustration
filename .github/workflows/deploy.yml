# ========================================
# .github/workflows/deploy.yml (FINAL)
# ========================================
name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create backend .env file
      run: |
        cat > backend/.env << 'EOF'
        ${{ secrets.BACKEND_ENV }}
        EOF
        echo "âœ… Backend .env created"
    
    - name: Create frontend .env file  
      run: |
        cat > frontend/.env << 'EOF'
        ${{ secrets.FRONTEND_ENV }}
        EOF
        echo "âœ… Frontend .env created"
    
    - name: Setup SSH directory
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
    
    - name: Add SSH key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
    
    - name: Add server to known hosts
      run: |
        ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Ensure project directories exist
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          mkdir -p ${{ secrets.DEPLOY_PATH }}/backend
          mkdir -p ${{ secrets.DEPLOY_PATH }}/frontend
    
    - name: Copy .env files to server
      run: |
        scp -i ~/.ssh/deploy_key -P ${{ secrets.SSH_PORT || '22' }} \
          -o StrictHostKeyChecking=no \
          backend/.env \
          ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/backend/.env
        
        scp -i ~/.ssh/deploy_key -P ${{ secrets.SSH_PORT || '22' }} \
          -o StrictHostKeyChecking=no \
          frontend/.env \
          ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/frontend/.env
        
        echo "âœ… Environment files copied to server"
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          set -e
          
          echo "ğŸ“‚ Navigating to project directory..."
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ“¦ Pulling latest code from GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ›‘ Stopping existing containers..."
          sudo docker compose down || true
          
          echo "ğŸ§¹ Removing old images..."
          sudo docker compose down --rmi local || true
          
          echo "ğŸ—ï¸ Building and starting containers..."
          sudo docker compose build --no-cache
          sudo docker compose up -d
          
          echo "â³ Waiting for services to be ready..."
          sleep 15
          
          echo "ğŸ”„ Running database migrations..."
          sudo docker compose exec -T yaw-backend python manage.py migrate --noinput
          
          echo "ğŸ“ Collecting static files..."
          sudo docker compose exec -T yaw-backend python manage.py collectstatic --noinput --clear
          
          echo "ğŸ” Checking container status..."
          sudo docker compose ps
          
          echo "ğŸ“Š Checking logs for errors..."
          sudo docker compose logs --tail=50 yaw-backend
          
          echo "ğŸ‰ Deployment completed successfully!"
    
    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key
        rm -f backend/.env
        rm -f frontend/.env
    
    - name: Deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… ğŸ‰ Deployment successful!"
          echo "ğŸŒ Frontend: https://yaw.nishanaweb.cloud"
          echo "ğŸ”§ Backend API: https://api.yaw.nishanaweb.cloud"
        else
          echo "âŒ Deployment failed! Check the logs above."
          exit 1
        fi